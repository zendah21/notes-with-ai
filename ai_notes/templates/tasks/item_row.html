{% set pr = task.priority %}
{% set card_cls = 'card-pr-medium' %}
{% if pr == 'high' %}{% set card_cls = 'card-pr-high' %}{% elif pr == 'urgent' %}{% set card_cls = 'card-pr-urgent' %}{% elif pr == 'low' %}{% set card_cls = 'card-pr-low' %}{% endif %}
<div id="task-card-{{ task.id }}" class="col-12 col-md-6 col-lg-4 mb-3">
  <div class="card shadow-sm h-100 {{ card_cls }}">
    <div class="card-body d-flex flex-column">
      <div class="d-flex align-items-start justify-content-between mb-2">
        <h5 class="card-title mb-0" title="{{ task.title }}">{{ task.title }}</h5>
        <div>
          {% set st = task.status %}
          {% set st_cls = 'secondary' %}
          {% if st == 'done' %}{% set st_cls = 'success' %}{% elif st == 'in_progress' %}{% set st_cls = 'info' %}{% endif %}
          <span class="badge text-bg-{{ st_cls }}">{{ st.replace('_',' ') }}</span>
        </div>
      </div>

      {% if task.description %}
      <div class="mb-2" style="color:#4a5568; white-space:pre-wrap;">{{ task.description }}</div>
      {% endif %}

      <div class="mb-2 small text-muted d-flex align-items-center flex-wrap gap-1">
        {% set pr_cls = 'secondary' %}
        {% if pr == 'high' %}{% set pr_cls = 'warning' %}{% elif pr == 'urgent' %}{% set pr_cls = 'danger' %}{% elif pr == 'low' %}{% set pr_cls = 'secondary' %}{% else %}{% set pr_cls = 'secondary' %}{% endif %}
        <form hx-post="/tasks/{{task.id}}/priority" hx-target="#task-card-{{task.id}}" hx-swap="outerHTML" class="d-inline">
          <input type="hidden" name="priority" value="low">
          <button type="submit" class="badge text-bg-secondary border-0">low</button>
        </form>
        <form hx-post="/tasks/{{task.id}}/priority" hx-target="#task-card-{{task.id}}" hx-swap="outerHTML" class="d-inline">
          <input type="hidden" name="priority" value="medium">
          <button type="submit" class="badge text-bg-secondary border-0">medium</button>
        </form>
        <form hx-post="/tasks/{{task.id}}/priority" hx-target="#task-card-{{task.id}}" hx-swap="outerHTML" class="d-inline">
          <input type="hidden" name="priority" value="high">
          <button type="submit" class="badge text-bg-warning border-0">high</button>
        </form>
        <form hx-post="/tasks/{{task.id}}/priority" hx-target="#task-card-{{task.id}}" hx-swap="outerHTML" class="d-inline">
          <input type="hidden" name="priority" value="urgent">
          <button type="submit" class="badge text-bg-danger border-0">urgent</button>
        </form>
        {% if task.estimated_duration_minutes %}
          <span class="badge text-bg-light border me-1">‚è± {{ task.estimated_duration_minutes }}m</span>
        {% endif %}
        {% if task.deadline_utc %}
          <span class="badge text-bg-light border">üìÖ {{ task.deadline_utc.strftime('%Y-%m-%d %H:%M') }} UTC</span>
        {% endif %}
      </div>

      {% if task.tag_list() %}
      <div class="mb-2">
        {% for t in task.tag_list() %}
          <span class="badge rounded-pill text-bg-secondary me-1">#{{ t }}</span>
        {% endfor %}
      </div>
      {% endif %}

      {% set notifs = task.notify_list() %}
      {% if notifs %}
        <div class="mb-2 small text-muted">üîî Alerts: {% for n in notifs %}{{ (n ~ 'm') if n < 60 else ((n//60) ~ 'h') }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
      {% endif %}

      <div class="mt-auto">
        <details>
          <summary class="small text-muted" style="cursor:pointer">Edit</summary>
          <form action="/tasks/{{task.id}}/edit" method="post" class="mt-2">
            <div class="mb-2">
              <input class="form-control form-control-sm" name="title" value="{{ task.title }}" placeholder="Title" />
            </div>
            <div class="mb-2">
              <textarea class="form-control form-control-sm" name="description" rows="3" placeholder="Description">{{ task.description or '' }}</textarea>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-primary" type="submit" hx-post="/tasks/{{task.id}}/edit" hx-target="#task-card-{{task.id}}" hx-swap="outerHTML">Save</button>
              <button class="btn btn-sm btn-outline-secondary" type="button" hx-post="/tasks/{{task.id}}/toggle" hx-target="#task-card-{{task.id}}" hx-swap="outerHTML">{{ 'Reopen' if task.status=='done' else 'Complete' }}</button>
              <button class="btn btn-sm btn-outline-secondary" type="button" hx-post="/tasks/{{task.id}}/status" hx-vals='{"status":"in_progress"}' hx-target="#task-card-{{task.id}}" hx-swap="outerHTML">In&nbsp;Progress</button>
              <button class="btn btn-sm btn-outline-danger" type="button" hx-post="/tasks/{{task.id}}/delete" hx-target="#task-card-{{task.id}}" hx-swap="outerHTML" onclick="return confirm('Delete this task?')">Delete</button>
            </div>
          </form>
        </details>
      </div>
    </div>
  </div>
</div>
