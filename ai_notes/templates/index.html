{% extends 'base.html' %}
{% block content %}
<div class="row mb-4">
  <div class="col">
    <div class="card">
      <div class="card-body">
        <form action="/tasks/create" method="post" class="d-flex gap-2">
          <input class="form-control" name="title" placeholder="Quick add task" />
          <button class="btn btn-primary">Add</button>
          <a class="btn btn-outline-secondary" href="/ai/console">AI Console</a>
          <a class="btn btn-outline-secondary" href="/help">Help</a>
        </form>
      </div>
    </div>
  </div>
  <div class="col-12 mt-3">
    <div class="card">
      <div class="card-body">
        <div class="input-group mb-2">
          <input id="ai-cmd" class="form-control" placeholder="Try: Move 'Rise email' to Friday 9:30, 20m, high, alert 1h" />
          <button id="ai-send" class="btn btn-success">AI</button>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">Status: <span id="ai-status">idle</span></small>
          <form id="filter-form" class="d-flex flex-wrap gap-2"
                hx-get="/" hx-target="#tasks-grid-wrap" hx-select="#tasks-grid-wrap" hx-push-url="true" hx-trigger="change, keyup delay:300ms from:#q">
            <select class="form-select form-select-sm" name="status" aria-label="Status">
              <option value="" {{ '' == status_f and 'selected' or '' }}>All statuses</option>
              <option value="pending" {{ 'pending' == status_f and 'selected' or '' }}>Pending</option>
              <option value="in_progress" {{ 'in_progress' == status_f and 'selected' or '' }}>In progress</option>
              <option value="done" {{ 'done' == status_f and 'selected' or '' }}>Done</option>
            </select>
            <select class="form-select form-select-sm" name="priority" aria-label="Priority">
              <option value="" {{ '' == priority_f and 'selected' or '' }}>All priorities</option>
              <option value="low" {{ 'low' == priority_f and 'selected' or '' }}>Low</option>
              <option value="medium" {{ 'medium' == priority_f and 'selected' or '' }}>Medium</option>
              <option value="high" {{ 'high' == priority_f and 'selected' or '' }}>High</option>
              <option value="urgent" {{ 'urgent' == priority_f and 'selected' or '' }}>Urgent</option>
            </select>
            <select class="form-select form-select-sm" name="sort" aria-label="Sort">
              <option value="deadline" {{ 'deadline' == sort and 'selected' or '' }}>Sort by deadline</option>
              <option value="created_desc" {{ 'created_desc' == sort and 'selected' or '' }}>Newest first</option>
              <option value="title" {{ 'title' == sort and 'selected' or '' }}>Title Aâ†’Z</option>
            </select>
            <input id="q" class="form-control form-control-sm" name="q" value="{{ q_text }}" placeholder="Search title/description" />
            <a class="btn btn-sm btn-outline-secondary" href="/">Clear</a>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const btn = document.getElementById('ai-send');
      const input = document.getElementById('ai-cmd');
      const status = document.getElementById('ai-status');
      let ws;
      function ensure(){
        if (!ws || ws.readyState !== 1){
          ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/ai');
      ws.onmessage = (ev)=>{
        const msg = JSON.parse(ev.data);
        if (msg.phase === 'thinking') status.textContent = 'thinking';
        if (msg.phase === 'parsed') status.textContent = 'understood intent: ' + (msg.json.operation || '?');
        if (msg.phase === 'applied') status.textContent = 'applied task #' + msg.task_id;
        if (msg.phase === 'patch' && msg.html){
          const wrap = document.createElement('div');
          wrap.innerHTML = msg.html.trim();
          const el = wrap.firstElementChild;
          const grid = document.getElementById('tasks-grid');
          if (document.getElementById(el.id)){
            document.getElementById(el.id).outerHTML = el.outerHTML;
          } else if (grid) {
            grid.prepend(el);
          }
        }
        if (msg.phase === 'error') status.textContent = 'error: ' + msg.message;
        if (msg.phase === 'need_clarification' && Array.isArray(msg.options)){
          status.textContent = 'need clarification';
          // basic prompt for now
          const id = prompt('Multiple matches. Enter task id to target:\n' + msg.options.map(o=> `${o.id}: ${o.title}`).join('\n'));
          if (id){
            ws.send(JSON.stringify({utterance: input.value, choose_id: parseInt(id,10), context:{now_tz: 'Asia/Kuwait'}}));
          }
        }
      };
        }
      }
      btn.addEventListener('click', ()=>{
        ensure();
        ws.send(JSON.stringify({utterance: input.value, context:{now_tz: 'Asia/Kuwait'}}));
      });
    })();
  </script>
  <div class="col-12 mt-4" id="tasks-grid-wrap">
    <div class="d-flex align-items-center gap-2 mb-2">
      <span class="badge text-bg-secondary">Total: {{ total }}</span>
      <span class="badge text-bg-info">Pending: {{ pending_c }}</span>
      <span class="badge text-bg-warning">In progress: {{ prog_c }}</span>
      <span class="badge text-bg-success">Done: {{ done_c }}</span>
      {% if q_text %}<span class="text-muted small">Search: "{{ q_text }}"</span>{% endif %}
    </div>
    <div id="tasks-grid" class="row">
      {% if tasks %}
        {% for task in tasks %}
          {% include 'tasks/item_row.html' %}
        {% endfor %}
      {% else %}
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center text-muted">
              No tasks match your filters. Try clearing filters or add a new task.
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
